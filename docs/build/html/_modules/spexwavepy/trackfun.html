
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spexwavepy.trackfun &#8212; spexwavepy 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">spexwavepy 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spexwavepy.trackfun</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for spexwavepy.trackfun</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">natsort</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">spexwavepy.imstackfun</span> <span class="kn">import</span> <span class="n">Imagestack</span>
<span class="kn">from</span> <span class="nn">spexwavepy.corefun</span> <span class="kn">import</span> <span class="n">_indicator</span><span class="p">,</span> <span class="n">read_one</span><span class="p">,</span> <span class="n">crop_one</span><span class="p">,</span> <span class="n">Imagematch</span><span class="p">,</span> <span class="n">NormImage</span>
<span class="kn">from</span> <span class="nn">spexwavepy.corefun</span> <span class="kn">import</span> <span class="n">_initDisplay</span><span class="p">,</span> <span class="n">_contiDisplay</span>
<span class="kn">from</span> <span class="nn">spexwavepy.postfun</span> <span class="kn">import</span> <span class="n">slope_scan</span><span class="p">,</span> <span class="n">slope_pixel</span><span class="p">,</span> <span class="n">curv_scan</span><span class="p">,</span> <span class="n">curv_XST</span> 

<span class="n">__DEBUG</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="Tracking"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking">[docs]</a><span class="k">class</span> <span class="nc">Tracking</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A container for different speckle tracking algorithms. </span>
<span class="sd">    </span>
<span class="sd">    Parameters </span>
<span class="sd">    ----------</span>
<span class="sd">    imstack1 : Imagestack class</span>
<span class="sd">        The first image stack.</span>
<span class="sd">        For XSS technique, it is scanned in x | y direction.</span>
<span class="sd">    imstack2 : Imagestack class</span>
<span class="sd">        The second image stack.</span>
<span class="sd">        For XSS technique, it is scanned in x | y direction.</span>
<span class="sd">        Not always necessary. (default None)</span>
<span class="sd">    imstack3 : Imagestack class</span>
<span class="sd">        The third image stack. </span>
<span class="sd">        For XSS technique, it is scanned in y direction.</span>
<span class="sd">        /Not always necessary. (default None)</span>
<span class="sd">    imstack4 : Imagestack class</span>
<span class="sd">        The fourth image stack. </span>
<span class="sd">        For XSS technique, it is scanned in y direction.</span>
<span class="sd">        Not always necessary. (default None)</span>
<span class="sd">    dimension : str</span>
<span class="sd">        &#39;1D&#39; or &#39;2D&#39;. To do 1D or 2D data processing. (default &#39;2D&#39;)</span>
<span class="sd">    scandim : str</span>
<span class="sd">        &#39;x&#39;|&#39;y&#39;|&#39;xy&#39;|&#39;random&#39;. Scan direction for the image stack. </span>
<span class="sd">        (default &#39;x&#39;)</span>
<span class="sd">    mempos : str</span>
<span class="sd">        &#39;downstream&#39; or &#39;upstream&#39;. Use this to define the position of </span>
<span class="sd">        the diffusor in respect to the focus of the optics. &#39;downstream&#39;</span>
<span class="sd">        means the diffuser is placed downstream of the focus. See </span>
<span class="sd">        *User guide: Local curvature reconstruction* for more </span>
<span class="sd">        details of it. (default &#39;downstream&#39;)</span>
<span class="sd">    scanstep : float</span>
<span class="sd">        scan step size, unit in :math:`\mu m`. (default None)</span>
<span class="sd">    pixsize : float</span>
<span class="sd">        detector pixel size, unit in :math:`\mu m`. (default None)</span>
<span class="sd">    dist : float</span>
<span class="sd">        distance from diffuser to detector plane, </span>
<span class="sd">        if it&#39;s the downstream mode, ``mempos`` is &#39;downstream&#39; (default),</span>
<span class="sd">        unit in mm. If the diffuser is placed in the upstream,</span>
<span class="sd">        ``mempos`` is &#39;upstream&#39;,</span>
<span class="sd">        usually it is set to be the distance between the centre </span>
<span class="sd">        of the optic to the detector. (default None)</span>
<span class="sd">    subpixelmeth : str</span>
<span class="sd">        &#39;default&#39;, &#39;gausspeak&#39; or &#39;parapeak&#39;. (default &#39;default&#39;). </span>
<span class="sd">        Method used for subpixel registration.</span>
<span class="sd">    delayX : numpy.ndarray</span>
<span class="sd">        The tracked 1D/2D shifts in X direction.</span>
<span class="sd">    delayY : numpy.ndarray</span>
<span class="sd">        The tracked 1D/2D shifts in Y direction.</span>
<span class="sd">    resX : numpy.ndarray</span>
<span class="sd">        The tracking 1D/2D coeffcient in X direction.</span>
<span class="sd">    resY : numpy.ndarray</span>
<span class="sd">        The tracking 1D/2D coeffcient in Y direction.</span>
<span class="sd">    sloX : numpy.ndarray</span>
<span class="sd">        The reconstructed slope error in X direction.</span>
<span class="sd">    sloY : numpy.ndarray</span>
<span class="sd">        The reconstructed slope error in Y direction.</span>
<span class="sd">    curvX : numpy.ndarray</span>
<span class="sd">        The reconstructed local curvature in X direction.</span>
<span class="sd">    curvY : numpy.ndarray</span>
<span class="sd">        The reconstructed local curvature in Y direction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imstack1</span><span class="p">,</span> <span class="n">imstack2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imstack3</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imstack4</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imstack1 : Imagestack class</span>
<span class="sd">            The first image stack.</span>
<span class="sd">        imstack2 : Imagestack class</span>
<span class="sd">            The second image stack. (default None)</span>
<span class="sd">        imstack3 : Imagestack class</span>
<span class="sd">            The third image stack. (default None)</span>
<span class="sd">        imstack4 : Imagestack class</span>
<span class="sd">            The fourth image stack. (default None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span> <span class="o">=</span> <span class="n">imstack1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">=</span> <span class="n">imstack2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">=</span> <span class="n">imstack3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span> <span class="o">=</span> <span class="n">imstack4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="s1">&#39;2D&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span> <span class="o">=</span> <span class="s1">&#39;downstream&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curvX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curvY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span>

    <span class="nd">@dimension</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1D&#39;</span><span class="p">,</span> <span class="s1">&#39;2D&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracking.dimension needs to be &#39;1D&#39; or &#39;2D&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dimension</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scandim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scandim</span>

    <span class="nd">@scandim</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scandim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39;or &#39;xy&#39;, or &#39;random&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scandim</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mempos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mempos</span>

    <span class="nd">@mempos</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mempos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;downstream&#39;</span><span class="p">,</span> <span class="s1">&#39;upstream&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized mempos. It should be &#39;downstream&#39; or &#39;upstream&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mempos</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scanstep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scanstep</span>

    <span class="nd">@scanstep</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scanstep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scanstep</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixsize</span>

    <span class="nd">@pixsize</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pixsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixsize</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dist</span>

    <span class="nd">@dist</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dist</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subpixelmeth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subpixelmeth</span>

    <span class="nd">@subpixelmeth</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">subpixelmeth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;gausspeak&#39;</span><span class="p">,</span> <span class="s1">&#39;parapeak&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not supported subpixel registration method.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subpixelmeth</span><span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="Tracking.stability"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.stability">[docs]</a>    <span class="k">def</span> <span class="nf">stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the stability using speckle pattern.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Cutting area of the reference image in x direction.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Cutting area of the reference image in y direction.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ixs, iys, res : numpy.array</span>
<span class="sd">            Shifts in two dimensions and the correlation coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imNo</span><span class="p">,</span> <span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
            <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">_indicator</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">imNo</span><span class="p">,</span> <span class="s1">&#39;Stability&#39;</span><span class="p">)</span>
                <span class="n">im2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">im2</span> <span class="o">=</span> <span class="n">im2</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span><span class="p">)</span>
                <span class="n">ixs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_tmp</span> <span class="o">-</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">iys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_tmp</span> <span class="o">-</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">iys</span><span class="p">,</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fpath</span>
            <span class="n">file_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fstart</span>
            <span class="n">file_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fstep</span>
            <span class="n">fileNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fnum</span>
            <span class="n">fileNames</span> <span class="o">=</span> <span class="n">natsort</span><span class="o">.</span><span class="n">natsorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">fileNum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fileNames</span> <span class="o">=</span> <span class="n">fileNames</span><span class="p">[</span><span class="n">file_start</span><span class="p">::</span><span class="n">file_step</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileNames</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fileNames</span> <span class="o">=</span> <span class="n">fileNames</span><span class="p">[</span><span class="n">file_start</span><span class="p">:</span><span class="n">file_start</span><span class="o">+</span><span class="n">fileNum</span><span class="o">*</span><span class="n">file_step</span><span class="p">:</span><span class="n">file_step</span><span class="p">]</span>
            <span class="n">im1_tmp</span> <span class="o">=</span> <span class="n">read_one</span><span class="p">(</span><span class="n">fileNames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ShowImage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="n">crop_one</span><span class="p">(</span><span class="n">im1_tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">imNo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileNames</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
            <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">_indicator</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">imNo</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;Stability&#39;</span><span class="p">)</span>
                <span class="n">im2_tmp</span> <span class="o">=</span> <span class="n">read_one</span><span class="p">(</span><span class="n">fileNames</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">im2_tmp</span> <span class="o">=</span> <span class="n">crop_one</span><span class="p">(</span><span class="n">im2_tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
                <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="n">im2_tmp</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">im2</span> <span class="o">=</span> <span class="n">im2_tmp</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span><span class="p">)</span> 
                <span class="n">ix_tmp</span> <span class="o">-=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">iy_tmp</span> <span class="o">-=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span>
                <span class="n">ixs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_tmp</span>
                <span class="n">iys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_tmp</span>
                <span class="n">res</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_tmp</span>

            <span class="k">return</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">iys</span><span class="p">,</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Tracking.stability_multi"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.stability_multi">[docs]</a>    <span class="k">def</span> <span class="nf">stability_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiprocessing version of stability function.</span>

<span class="sd">        .. warning:: **BE CAREFUL** to check the available and safe cpu numbers before run this function!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Cutting area of the reference image in x direction.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Cutting area of the reference image in y direction.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        cpu_no : int</span>
<span class="sd">            Number of CPU to be used. </span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ixs, iys, res : numpy.array</span>
<span class="sd">            Shifts in two dimensions and the coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fpath</span>
        <span class="n">file_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fstart</span>
        <span class="n">file_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fstep</span>
        <span class="n">fileNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">fnum</span>
        <span class="n">fileNames</span> <span class="o">=</span> <span class="n">natsort</span><span class="o">.</span><span class="n">natsorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">fileNum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fileNames</span> <span class="o">=</span> <span class="n">fileNames</span><span class="p">[</span><span class="n">file_start</span><span class="p">::</span><span class="n">file_step</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fnum</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileNames</span><span class="p">)</span>
            <span class="n">fileNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileNames</span> <span class="o">=</span> <span class="n">fileNames</span><span class="p">[</span><span class="n">file_start</span><span class="p">:</span><span class="n">file_start</span><span class="o">+</span><span class="n">fileNum</span><span class="o">*</span><span class="n">file_step</span><span class="p">:</span><span class="n">file_step</span><span class="p">]</span>
        <span class="n">jxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fileNum</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fileNum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fileNum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fileNum</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">process_tmp</span>
        <span class="k">def</span> <span class="nf">process_tmp</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1">#The indications may not appear in correct order, however, it may still be useful to keep outputing some information.</span>
                <span class="n">_indicator</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;Stability&#39;</span><span class="p">)</span> 
            <span class="n">im1_tmp</span> <span class="o">=</span> <span class="n">read_one</span><span class="p">(</span><span class="n">fileNames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="n">crop_one</span><span class="p">(</span><span class="n">im1_tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">im2_tmp</span> <span class="o">=</span> <span class="n">read_one</span><span class="p">(</span><span class="n">fileNames</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">im2_tmp</span> <span class="o">=</span> <span class="n">crop_one</span><span class="p">(</span><span class="n">im2_tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">roi</span><span class="p">)</span>
            <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="n">im2_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">im2</span> <span class="o">=</span> <span class="n">im2_tmp</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span><span class="p">)</span> 
            <span class="n">ix_tmp</span> <span class="o">-=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iy_tmp</span> <span class="o">-=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span>

        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_no</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_tmp</span><span class="p">,</span> <span class="n">jxs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
            <span class="n">ixs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">iys</span><span class="p">,</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Tracking.collimate"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.collimate">[docs]</a>    <span class="k">def</span> <span class="nf">collimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function uses the first image from both imstack1 and imstack2</span>
<span class="sd">        to align the speckle patterns in the image stacks. </span>
<span class="sd">        It is called before any further tracking method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
        <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="n">im_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">im_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_size_tmp</span><span class="p">,</span> <span class="n">x_size_tmp</span> <span class="o">=</span> <span class="n">im_temp</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">im_temp</span> <span class="o">=</span> <span class="n">im_temp</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">y_size_tmp</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_size_tmp</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">im_ref</span><span class="p">,</span> <span class="n">im_temp</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span>
        <span class="n">ix_tmp</span> <span class="o">-=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iy_tmp</span> <span class="o">-=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ix_tmp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ix_tmp</span><span class="p">)</span>
        <span class="n">iy_tmp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">iy_tmp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Too low correlate coefficient, may have wrong tracking value!&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The coefficient is </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">iy_tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data1_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_tmp1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data1_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">data2_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="n">y_tmp2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data2_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_tmp1</span><span class="p">,</span> <span class="n">y_tmp2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">y_tmp</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">iy_tmp</span><span class="p">:</span><span class="n">iy_tmp</span><span class="o">+</span><span class="n">y_tmp</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data1_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">iy_tmp</span><span class="p">):,</span> <span class="p">:]</span>
            <span class="n">y_tmp1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data1_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">data2_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_tmp2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">data2_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_tmp1</span><span class="p">,</span> <span class="n">y_tmp2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">iy_tmp</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">iy_tmp</span><span class="p">)</span><span class="o">+</span><span class="n">y_tmp</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">y_tmp</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">ix_tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data1_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">x_tmp1</span> <span class="o">=</span> <span class="n">data1_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">data2_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ix_tmp</span><span class="p">:]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">x_tmp2</span> <span class="o">=</span> <span class="n">data2_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">x_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_tmp1</span><span class="p">,</span> <span class="n">x_tmp2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">x_tmp</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ix_tmp</span><span class="p">:</span><span class="n">ix_tmp</span><span class="o">+</span><span class="n">x_tmp</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data1_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ix_tmp</span><span class="p">):]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">x_tmp1</span> <span class="o">=</span> <span class="n">data1_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">data2_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">x_tmp2</span> <span class="o">=</span> <span class="n">data2_tmp</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">x_tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_tmp1</span><span class="p">,</span> <span class="n">x_tmp2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ix_tmp</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ix_tmp</span><span class="p">)</span><span class="o">+</span><span class="n">x_tmp</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">x_tmp</span><span class="p">]</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_XSS_2stacks_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **1D** speckle tracking for XSS technique with reference beam.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ixs, iys, resmax : numpy.array</span>
<span class="sd">            Shifts in x and y and the coefficient if _Resreturn=True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized 1D scan mode. The supported methods are 1D X and 1D Y scan.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">)</span>
        <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 
        <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">imNo</span><span class="o">-</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">y_dim</span> <span class="o">=</span> <span class="n">y_dim_tmp</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y_dim</span><span class="p">)</span>
        <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y_dim</span><span class="p">)</span>
        <span class="n">resmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y_dim</span><span class="p">)</span>
        <span class="n">plane1_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">plane2_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">plane1_init</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">plane1_init</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane1_init</span><span class="p">)</span> 
            <span class="n">plane2_init</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane2_init</span><span class="p">)</span> 
        <span class="n">ix_init</span><span class="p">,</span> <span class="n">iy_init</span><span class="p">,</span> <span class="n">res_init</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">plane2_init</span><span class="p">,</span> <span class="n">plane1_init</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span> <span class="o">=</span> <span class="n">_initDisplay</span><span class="p">(</span><span class="n">plane1_init</span><span class="p">,</span> <span class="n">plane2_init</span><span class="p">,</span> <span class="n">res_init</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_dim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="n">_indicator</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in X direction&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="n">_indicator</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in Y direction&#39;</span><span class="p">)</span>
            <span class="n">plane1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">plane2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">plane1</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane1</span><span class="p">)</span>
                <span class="n">plane2</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane2</span><span class="p">)</span>
            <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">plane2</span><span class="p">,</span> <span class="n">plane1</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span> 
            <span class="n">ixs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_tmp</span> <span class="o">-</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_tmp</span> <span class="o">-</span> <span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">resmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                <span class="n">_contiDisplay</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span><span class="p">,</span> <span class="n">plane1</span><span class="p">,</span> <span class="n">plane2</span><span class="p">,</span> <span class="n">res_tmp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">iys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">ixs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">resmax</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">iys</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="n">resmax</span>

        <span class="k">if</span> <span class="n">_Resreturn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">iys</span><span class="p">,</span> <span class="n">resmax</span>

<div class="viewcode-block" id="Tracking.XSS_withrefer"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XSS_withrefer">[docs]</a>    <span class="k">def</span> <span class="nf">XSS_withrefer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">hw_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for XSS technique with reference beam.</span>
<span class="sd">        Two image stacks are needed to define the Tracking class.</span>
<span class="sd">        The fisrt image stack is the one with test optic.</span>
<span class="sd">        The second image stack is the reference image stack.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        edge_z : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in scan number dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The width/height of the image subregion. If Tracking.scandim is &#39;x&#39;,</span>
<span class="sd">            it is the height of the subregion; if Tracking.scandim is &#39;y&#39;,</span>
<span class="sd">            it is the width of the subregion.</span>
<span class="sd">            Needed when do 2D data processing. (default None) </span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">            Needed when do 2D data processing. (default None)</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s1">&#39;XSS(with reference)&#39;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">hw_xy</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39; or &#39;xy&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#if scandim == &#39;diag&#39;:</span>
        <span class="c1">#    self.imstack3 = copy.deepcopy(self.imstack1)</span>
        <span class="c1">#    self.imstack4 = copy.deepcopy(self.imstack2)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">edge_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">edge_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
            <span class="n">verbose_tmp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span>
            <span class="n">verbose_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_x</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_y</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_XSS_2stacks_1D</span><span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_x</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_y</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_xy</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">pad_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edge_x</span> <span class="o">!=</span> <span class="n">edge_y</span> <span class="ow">or</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the edges should be symmetrical, edge_x should be the same as edge_y, and also the elements of each.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the pad should be symmetrical.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad_xy should not be greater than edge_xy.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">imNo</span><span class="o">-</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">imNo_tmp</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">jxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">delayY_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">delayX_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">res_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1">#if self.scandim == &#39;xy&#39; or self.scandim == &#39;diag&#39;: self.scandim = &#39;x&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jxs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in X direction&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="p">:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">edge_xy_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edge_z_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ix_new</span><span class="p">,</span> <span class="n">iy_new</span><span class="p">,</span> <span class="n">res_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XSS_2stacks_1D</span><span class="p">(</span><span class="n">edge_xy_new</span><span class="p">,</span> <span class="n">edge_z_new</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">delayX_2D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_new</span> <span class="o">-</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">delayY_2D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_new</span> <span class="o">-</span> <span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">res_2D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_new</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayY_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayX_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">res_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
            <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_x</span>
                <span class="k">if</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad_xy should not be greater than edge_xy.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">imNo2</span><span class="p">,</span> <span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="n">x_dim_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">imNo2</span><span class="o">-</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp2</span><span class="o">-</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">imNo_tmp2</span><span class="p">,</span> <span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="n">x_dim_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">jxs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp2</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">delayY_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)))</span>
                <span class="n">delayX_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)))</span>
                <span class="n">res_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)))</span>
                <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack3_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack4_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jxs2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in Y direction&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack3_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="p">:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack4_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">edge_xy_new</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">edge_z_new</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ix_new2</span><span class="p">,</span> <span class="n">iy_new2</span><span class="p">,</span> <span class="n">res_new2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XSS_2stacks_1D</span><span class="p">(</span><span class="n">edge_xy_new</span><span class="p">,</span> <span class="n">edge_z_new</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">delayX_2D_2</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_new2</span> <span class="o">-</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">delayY_2D_2</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_new2</span> <span class="o">-</span> <span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">res_2D_2</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_new2</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="n">scandim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span>

                <span class="c1">### To cut the 2D map (align the results in two directions) for post-processing</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">[:,</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">[:,</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="c1">#if scandim != &#39;diag&#39;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

        <span class="k">return</span></div>
    
<div class="viewcode-block" id="Tracking.XSS_withrefer_multi"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XSS_withrefer_multi">[docs]</a>    <span class="k">def</span> <span class="nf">XSS_withrefer_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for XSS technique with reference beam.</span>
<span class="sd">        The fisrt image stack is the one with test optic.</span>
<span class="sd">        The second image stack is the reference image stack.</span>

<span class="sd">        .. warning:: **BE CAREFUL** to check the available and safe cpu numbers before run this function!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        edge_z : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in scan number dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The width/height of the image subregion. If Tracking.scandim is &#39;x&#39;,</span>
<span class="sd">            it is the height of the subregion; if Tracking.scandim is &#39;y&#39;,</span>
<span class="sd">            it is the width of the subregion.</span>
<span class="sd">            Needed when do 2D data processing. (default None) </span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">            Needed when do 2D data processing. (default None)</span>
<span class="sd">        cpu_no : int</span>
<span class="sd">            The number of CPUs that is available.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s1">&#39;XSS(with reference)&#39;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">hw_xy</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">width</span> <span class="o">+=</span> <span class="mi">1</span>       <span class="c1"># width should be even</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39; or &#39;xy&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#if scandim == &#39;diag&#39;:</span>
        <span class="c1">#    self.imstack3 = copy.deepcopy(self.imstack1)</span>
        <span class="c1">#    self.imstack4 = copy.deepcopy(self.imstack2)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">edge_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">edge_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
            <span class="n">verbose_tmp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span>
            <span class="n">verbose_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No need to use multiprocessing for 1D analysis.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_x</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_y</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_xy</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">pad_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">edge_x</span> <span class="o">!=</span> <span class="n">edge_y</span> <span class="ow">or</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the edges should be symmetrical, edge_x should be the same as edge_y, and also the elements of each.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the pad should be symmetrical, pad_x should be the same as pad_y, and also the elements of each.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad_xy should not be greater than edge_xy.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">imNo</span><span class="o">-</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">imNo_tmp</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">jxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">delayY_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">delayX_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">res_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1">#if self.scandim == &#39;xy&#39; or self.scandim == &#39;diag&#39;: self.scandim = &#39;x&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
            <span class="n">jxs1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jxs</span><span class="p">)</span>
            <span class="k">global</span> <span class="n">process_tmp1</span>
            <span class="k">def</span> <span class="nf">process_tmp1</span><span class="p">(</span><span class="n">jx</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs1</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in X direction&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs1</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in Y direction&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="p">:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">edge_xy_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edge_z_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ix_new1</span><span class="p">,</span> <span class="n">iy_new1</span><span class="p">,</span> <span class="n">res_new1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XSS_2stacks_1D</span><span class="p">(</span><span class="n">edge_xy_new</span><span class="p">,</span> <span class="n">edge_z_new</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ix_new1</span> <span class="o">-=</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">iy_new1</span> <span class="o">-=</span> <span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">ix_new1</span><span class="p">,</span> <span class="n">iy_new1</span><span class="p">,</span> <span class="n">res_new1</span>

            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_no</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_tmp1</span><span class="p">,</span> <span class="n">jxs1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
                <span class="n">delayX_2D</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">delayY_2D</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">res_2D</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayY_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayX_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">res_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_xy</span> <span class="o">=</span> <span class="n">edge_x</span>
                <span class="k">if</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad_xy should not be greater than edge_xy.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">imNo2</span><span class="p">,</span> <span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="n">x_dim_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">imNo2</span><span class="o">-</span><span class="n">edge_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp2</span><span class="o">-</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">imNo_tmp2</span><span class="p">,</span> <span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="n">x_dim_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">jxs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp2</span><span class="o">-</span><span class="n">width</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">delayY_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)))</span>
                <span class="n">delayX_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)))</span>
                <span class="n">res_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)))</span>
                <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack3_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack4_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
                <span class="n">jxs2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jxs2</span><span class="p">)</span>
                <span class="k">global</span> <span class="n">process_tmp2</span>
                <span class="k">def</span> <span class="nf">process_tmp2</span><span class="p">(</span><span class="n">jx</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in Y direction&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack3_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="p">:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack4_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">width</span><span class="o">+</span><span class="n">jx</span><span class="o">+</span><span class="n">edge_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">edge_xy_new</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">edge_z_new</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ix_new2</span><span class="p">,</span> <span class="n">iy_new2</span><span class="p">,</span> <span class="n">res_new2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XSS_2stacks_1D</span><span class="p">(</span><span class="n">edge_xy_new</span><span class="p">,</span> <span class="n">edge_z_new</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ix_new2</span> <span class="o">-=</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">iy_new2</span> <span class="o">-=</span> <span class="n">edge_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">return</span> <span class="n">ix_new2</span><span class="p">,</span> <span class="n">iy_new2</span><span class="p">,</span> <span class="n">res_new2</span>

                <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_no</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_tmp2</span><span class="p">,</span> <span class="n">jxs2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
                    <span class="n">delayX_2D_2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">delayY_2D_2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">res_2D_2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="n">scandim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D_2</span>

                <span class="c1">### To cut the 2D map (align the results in two directions) for post-processing</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">[:,</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">[:,</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">[</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">width</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="c1">#if scandim != &#39;diag&#39;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Tracking.XSS_self"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XSS_self">[docs]</a>    <span class="k">def</span> <span class="nf">XSS_self</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">hw_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for self-reference XSS technique.</span>
<span class="sd">        Only one image stack, the one with test optic, is needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        edge_z : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in scan number dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">        nstep : int</span>
<span class="sd">            The space between two chosen columns or rows.</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The width/height of the image subregion. If Tracking.scandim is &#39;x&#39;,</span>
<span class="sd">            it is the height of the subregion; if Tracking.scandim is &#39;y&#39;,</span>
<span class="sd">            it is the width of the subregion.</span>
<span class="sd">            Needed when do 2D data processing. (default None) </span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">            Needed when do 2D data processing. (default None)</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;Self-reference XSS&quot;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">hw_xy</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39; or &#39;xy&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This method needs to be implemented. Try to use &#39;x&#39; and &#39;y&#39; seperately.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only one image stack is needed. Please check your input.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">nstep</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">y_dim</span><span class="o">-</span><span class="n">nstep</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">nstep</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">x_dim</span><span class="o">-</span><span class="n">nstep</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XSS_withrefer</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curvX</span> <span class="o">=</span> <span class="n">curv_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Tracking.XSS_self_multi"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XSS_self_multi">[docs]</a>    <span class="k">def</span> <span class="nf">XSS_self_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for self-reference XSS technique. </span>
<span class="sd">        Only one image stack, the one with test optic, is needed.</span>

<span class="sd">        .. warning:: **BE CAREFUL** to check the available and safe cpu numbers before run this function!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        edge_z : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in scan number dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">        nstep : int</span>
<span class="sd">            The space between two chosen columns or rows.</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The width/height of the image subregion. If Tracking.scandim is &#39;x&#39;,</span>
<span class="sd">            it is the height of the subregion; if Tracking.scandim is &#39;y&#39;,</span>
<span class="sd">            it is the width of the subregion.</span>
<span class="sd">            Needed when do 2D data processing.</span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">            Needed when do 2D data processing. </span>
<span class="sd">        cpu_no : int</span>
<span class="sd">            The number of CPUs that is available.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;Self-reference XSS&quot;</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">hw_xy</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39; or &#39;xy&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This method needs to be implemented. Try to use &#39;x&#39; and &#39;y&#39; seperately.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only one image stack is needed. Please check your input.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">nstep</span><span class="p">:,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">y_dim</span><span class="o">-</span><span class="n">nstep</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">nstep</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">x_dim</span><span class="o">-</span><span class="n">nstep</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XSS_withrefer_multi</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curvX</span> <span class="o">=</span> <span class="n">curv_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_XST_2images_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **1D** self-reference conventional speckle tracking technique. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to the list [int, int].</span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            Needed when do 2D data processing. (default None)</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            It defines the width or height that needed in the template image </span>
<span class="sd">            for x or y data processing. </span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ixs, iys, resmax : numpy.array</span>
<span class="sd">            Shifts in x and y and the coefficient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized 1D scan mode. The supported methods are 1D X and 1D Y scan.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_xy</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pad_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">)</span>
        <span class="c1">#if scandim == &#39;x&#39;:</span>
        <span class="c1">#    if pad_xy[0] &gt; edge_x[0] or pad_xy[1] &gt; edge_x[1]:</span>
        <span class="c1">#        print(&quot;pad_xy should not be greater than edge_x.&quot;)</span>
        <span class="c1">#        sys.exit(0)</span>
        <span class="c1">#if scandim == &#39;y&#39;:</span>
        <span class="c1">#    if pad_xy[0] &gt; edge_y[0] or pad_xy[1] &gt; edge_y[1]:</span>
        <span class="c1">#        print(&quot;pad_xy should not be greater than edge_y.&quot;)</span>
        <span class="c1">#        sys.exit(0)</span>
        <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 
        <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y_dim</span> <span class="o">=</span> <span class="n">y_dim_tmp</span> <span class="o">-</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="n">hw_xy</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y_dim</span><span class="p">)</span>
        <span class="n">iys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y_dim</span><span class="p">)</span>
        <span class="n">resmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y_dim</span><span class="p">)</span>
        <span class="n">plane1_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">hw_xy</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">plane2_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">hw_xy</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">plane1_init</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane1_init</span><span class="p">)</span> 
            <span class="n">plane2_init</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane2_init</span><span class="p">)</span> 
        <span class="n">ix_init</span><span class="p">,</span> <span class="n">iy_init</span><span class="p">,</span> <span class="n">res_init</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">plane2_init</span><span class="p">,</span> <span class="n">plane1_init</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span> <span class="o">=</span> <span class="n">_initDisplay</span><span class="p">(</span><span class="n">plane1_init</span><span class="p">,</span> <span class="n">plane2_init</span><span class="p">,</span> <span class="n">res_init</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_dim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="n">_indicator</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in X direction&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="n">_indicator</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in Y direction&#39;</span><span class="p">)</span>
            <span class="n">plane1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">hw_xy</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">plane2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">hw_xy</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">plane1</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane1</span><span class="p">)</span>
                <span class="n">plane2</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">plane2</span><span class="p">)</span>
            <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">plane2</span><span class="p">,</span> <span class="n">plane1</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span> 
            <span class="n">ixs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_tmp</span> <span class="o">-</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">iys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_tmp</span> <span class="o">-</span> <span class="n">pad_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">resmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                <span class="n">_contiDisplay</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span><span class="p">,</span> <span class="n">plane1</span><span class="p">,</span> <span class="n">plane2</span><span class="p">,</span> <span class="n">res_tmp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">iys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">ixs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">resmax</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">iys</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">ixs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="n">resmax</span>

        <span class="k">if</span> <span class="n">_Resreturn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ixs</span><span class="p">,</span> <span class="n">iys</span><span class="p">,</span> <span class="n">resmax</span>

<div class="viewcode-block" id="Tracking.XST_self"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XST_self">[docs]</a>    <span class="k">def</span> <span class="nf">XST_self</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for self-reference XST technique.</span>
<span class="sd">        Two image stacks are needed. Both are with test optic.</span>
<span class="sd">        One image stack consists only one image when the diffuser is at one position,</span>
<span class="sd">        another image stack consists another image when the diffuser</span>
<span class="sd">        is at another position.</span>

<span class="sd">        This technique has been described in [XST_selfpaper]_:</span>
<span class="sd">        </span>
<span class="sd">        .. [XST_selfpaper] Hu, L., Wang, H., Fox, O., &amp; Sawhney, K. (2022). </span>
<span class="sd">             Fast wavefront sensing for X-ray optics with an alternating speckle tracking technique. </span>
<span class="sd">             Opt. Exp., 30(18), 33259-33273.</span>
<span class="sd">             https://doi.org/10.1364/OE.460163</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        pad_x : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in x direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;y&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        pad_y : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in y direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;x&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The height (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the width (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">        window : int</span>
<span class="sd">            The width (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the height (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">            Only used when Tracking.dimension is &#39;2D&#39;. (default None)</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;Self-reference XST&quot;</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39; or &#39;xy&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
            <span class="n">verbose_tmp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span>
            <span class="n">verbose_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp2</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pad_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pad_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_y</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge_x</span> <span class="o">!=</span> <span class="n">edge_y</span> <span class="ow">or</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the edges should be symmetrical, edge_x should be the same as edge_y, and also the elements of each.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pad_x</span> <span class="o">!=</span> <span class="n">pad_y</span> <span class="ow">or</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pad_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the pad should be symmetrical, pad_x should be the same as pad_y, and also the elements of each.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">pad_y</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">pad_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_XST_2images_1D</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">pad_x</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">pad_xy</span> <span class="o">=</span> <span class="n">pad_y</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_XST_2images_1D</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvX</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
                <span class="n">edge_x_new</span> <span class="o">=</span> <span class="n">edge_y</span>
                <span class="n">edge_y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">pad_x_new</span> <span class="o">=</span> <span class="n">pad_y</span>
                <span class="n">pad_y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">edge_x_new</span> <span class="o">=</span> <span class="n">edge_x</span>
                <span class="n">edge_y_new</span> <span class="o">=</span> <span class="n">edge_y</span>
                <span class="n">pad_x_new</span> <span class="o">=</span> <span class="n">pad_x</span>
                <span class="n">pad_y_new</span> <span class="o">=</span> <span class="n">pad_y</span>
            <span class="k">if</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
            <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">jxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">delayY_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">delayX_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">res_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jxs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in X direction&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in Y direction&#39;</span><span class="p">)</span>
                <span class="n">y_ind_left</span> <span class="o">=</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y_ind_right</span> <span class="o">=</span> <span class="n">y_dim_tmp</span> <span class="o">-</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x_ind_left</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x_ind_right</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                <span class="n">ix_new</span><span class="p">,</span> <span class="n">iy_new</span><span class="p">,</span> <span class="n">res_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XST_2images_1D</span><span class="p">(</span><span class="n">pad_x_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">delayX_2D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_new</span> <span class="c1">#- pad_x_new[0]</span>
                <span class="n">delayY_2D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_new</span> <span class="c1">#- pad_y_new[0]</span>
                <span class="n">res_2D</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_new</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curvX</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayY_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayX_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">res_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curvX</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curvY</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">edge_x_new</span> <span class="o">=</span> <span class="n">edge_x</span>
                <span class="n">edge_y_new</span> <span class="o">=</span> <span class="n">edge_y</span>
                <span class="n">pad_x_new</span> <span class="o">=</span> <span class="n">pad_x</span>
                <span class="n">pad_y_new</span> <span class="o">=</span> <span class="n">pad_y</span>
                <span class="k">if</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
                <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">jxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">delayY_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
                <span class="n">delayX_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
                <span class="n">res_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
                <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack3_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack4_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jxs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                            <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in X direction&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                            <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in Y direction&#39;</span><span class="p">)</span>
                    <span class="n">y_ind_left</span> <span class="o">=</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y_ind_right</span> <span class="o">=</span> <span class="n">y_dim_tmp</span> <span class="o">-</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">x_ind_left</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">x_ind_right</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack3_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack4_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                    <span class="n">ix_new2</span><span class="p">,</span> <span class="n">iy_new2</span><span class="p">,</span> <span class="n">res_new2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XST_2images_1D</span><span class="p">(</span><span class="n">pad_x_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">delayX_2D_2</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_new2</span> <span class="c1">#- pad_x_new[0]</span>
                    <span class="n">delayY_2D_2</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_new2</span> <span class="c1">#- pad_y_new[0]</span>
                    <span class="n">res_2D_2</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_new2</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="n">scandim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curvX</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Tracking.XST_self_multi"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XST_self_multi">[docs]</a>    <span class="k">def</span> <span class="nf">XST_self_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for self-reference XST technique.</span>
<span class="sd">        Two image stacks are needed. Both are with test optic.</span>
<span class="sd">        One image stack consists one image when the diffuser is at one position,</span>
<span class="sd">        another image stack consists another image when the diffuser</span>
<span class="sd">        is at another position.</span>

<span class="sd">        This technique has been described in [XST_selfpaper2]_:</span>
<span class="sd">        </span>
<span class="sd">        .. [XST_selfpaper2] Hu, L., Wang, H., Fox, O., &amp; Sawhney, K. (2022). </span>
<span class="sd">             Fast wavefront sensing for X-ray optics with an alternating speckle tracking technique. </span>
<span class="sd">             Opt. Exp., 30(18), 33259-33273.</span>
<span class="sd">             https://doi.org/10.1364/OE.460163</span>

<span class="sd">        .. warning:: **BE CAREFUL** to check the available and safe cpu numbers before run this function!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        pad_x : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in x direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;y&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        pad_y : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in y direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;x&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The height (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the width (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">        window : int</span>
<span class="sd">            The width (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the height (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">            Only used when Tracking.dimension is &#39;2D&#39;. (default None)</span>
<span class="sd">        cpu_no : int</span>
<span class="sd">            The number of CPUs that is available.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;Self-reference XST&quot;</span>
        <span class="n">scandim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized scan mode. It should be &#39;x&#39;, &#39;y&#39; or &#39;xy&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
            <span class="n">verbose_tmp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span>
            <span class="n">verbose_tmp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rot90deg</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_tmp2</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_y</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pad_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad_y</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pad_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_y</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">edge_x</span> <span class="o">!=</span> <span class="n">edge_y</span> <span class="ow">or</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">edge_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the edges should be symmetrical, edge_x should be the same as edge_y, and also the elements of each.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pad_x</span> <span class="o">!=</span> <span class="n">pad_y</span> <span class="ow">or</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pad_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim == &#39;xy&#39;, the pad should be symmetrical, pad_x should be the same as pad_y, and also the elements of each.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No need to use multiprocessing for 1D analysis.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;2D&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> 
                <span class="n">edge_x_new</span> <span class="o">=</span> <span class="n">edge_y</span>
                <span class="n">edge_y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">edge_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">pad_x_new</span> <span class="o">=</span> <span class="n">pad_y</span>
                <span class="n">pad_y_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pad_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">edge_x_new</span> <span class="o">=</span> <span class="n">edge_x</span>
                <span class="n">edge_y_new</span> <span class="o">=</span> <span class="n">edge_y</span>
                <span class="n">pad_x_new</span> <span class="o">=</span> <span class="n">pad_x</span>
                <span class="n">pad_y_new</span> <span class="o">=</span> <span class="n">pad_y</span>
            <span class="k">if</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
            <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">jxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">delayY_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">delayX_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">res_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
            <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
            <span class="n">jxs1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jxs</span><span class="p">)</span>
            <span class="k">global</span> <span class="n">process_tmp1</span>
            <span class="k">def</span> <span class="nf">process_tmp1</span><span class="p">(</span><span class="n">jx</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs1</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in X direction&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs1</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in Y direction&#39;</span><span class="p">)</span>
                <span class="n">y_ind_left</span> <span class="o">=</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y_ind_right</span> <span class="o">=</span> <span class="n">y_dim_tmp</span> <span class="o">-</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x_ind_left</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x_ind_right</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                <span class="n">ix_new1</span><span class="p">,</span> <span class="n">iy_new1</span><span class="p">,</span> <span class="n">res_new1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XST_2images_1D</span><span class="p">(</span><span class="n">pad_x_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1">#ix_new1 -= pad_x_new[0]</span>
                <span class="c1">#iy_new1 -= pad_y_new[0]</span>

                <span class="k">return</span> <span class="n">ix_new1</span><span class="p">,</span> <span class="n">iy_new1</span><span class="p">,</span> <span class="n">res_new1</span>

            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_no</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_tmp1</span><span class="p">,</span> <span class="n">jxs1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
                <span class="n">delayX_2D</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">delayY_2D</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">res_2D</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curvX</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span> <span class="c1">#or scandim == &#39;diag&#39;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayY_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">delayX_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">res_2D</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">curvX</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curvY</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;xy&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
                <span class="c1"># For &#39;xy&#39; case, ROI should be a square, for 2D integaration </span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> \
                        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For scandim is &#39;xy&#39;, the ROI should be a square, please re-select.&quot;</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">edge_x_new</span> <span class="o">=</span> <span class="n">edge_x</span>
                <span class="n">edge_y_new</span> <span class="o">=</span> <span class="n">edge_y</span>
                <span class="n">pad_x_new</span> <span class="o">=</span> <span class="n">pad_x</span>
                <span class="n">pad_y_new</span> <span class="o">=</span> <span class="n">pad_y</span>
                <span class="k">if</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pad should not be greater than edge.&quot;</span><span class="p">)</span>
                <span class="n">imNo</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">jxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">delayY_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
                <span class="n">delayX_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
                <span class="n">res_2D_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hw_xy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs</span><span class="p">)))</span>
                <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack3_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">imstack4_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
                <span class="n">jxs2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jxs</span><span class="p">)</span>
                <span class="k">global</span> <span class="n">process_tmp2</span>
                <span class="k">def</span> <span class="nf">process_tmp2</span><span class="p">(</span><span class="n">jx</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                            <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39;technique in X direction&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                            <span class="n">_indicator</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jxs2</span><span class="p">),</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">+</span> <span class="s1">&#39; technique in Y direction&#39;</span><span class="p">)</span>
                    <span class="n">y_ind_left</span> <span class="o">=</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y_ind_right</span> <span class="o">=</span> <span class="n">y_dim_tmp</span> <span class="o">-</span> <span class="n">edge_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad_y_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">x_ind_left</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">x_ind_right</span> <span class="o">=</span> <span class="n">jx</span> <span class="o">+</span> <span class="n">edge_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">window</span> <span class="o">+</span> <span class="n">pad_x_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack3_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack4_data</span><span class="p">[:,</span> <span class="n">y_ind_left</span><span class="p">:</span><span class="n">y_ind_right</span><span class="p">,</span> <span class="n">x_ind_left</span><span class="p">:</span><span class="n">x_ind_right</span><span class="p">]</span>
                    <span class="n">ix_new2</span><span class="p">,</span> <span class="n">iy_new2</span><span class="p">,</span> <span class="n">res_new2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XST_2images_1D</span><span class="p">(</span><span class="n">pad_x_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">pad_y_new</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_Resreturn</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1">#ix_new2 -= pad_x_new[0]</span>
                    <span class="c1">#iy_new2 -= pad_y_new[0]</span>

                    <span class="k">return</span> <span class="n">ix_new2</span><span class="p">,</span> <span class="n">iy_new2</span><span class="p">,</span> <span class="n">res_new2</span>

                <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_no</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_tmp2</span><span class="p">,</span> <span class="n">jxs2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
                    <span class="n">delayX_2D_2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">delayY_2D_2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">res_2D_2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="n">scandim</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="n">delayX_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resY</span> <span class="o">=</span> <span class="n">res_2D_2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack1_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">imstack2_data</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">curvY</span> <span class="o">=</span> <span class="n">curv_XST</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mempos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_curvX</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Tracking.XST_withrefer"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XST_withrefer">[docs]</a>    <span class="k">def</span> <span class="nf">XST_withrefer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for conventional XST technique, with reference beam.</span>
<span class="sd">        Two image stacks are needed. </span>
<span class="sd">        The fisrt image stack consists one image when the diffuser is in the beam,</span>
<span class="sd">        another image stack consists one reference image without the tested optic.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        pad_x : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in x direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;y&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        pad_y : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in y direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;x&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The height (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the width (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">        window : int</span>
<span class="sd">            The width (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the height (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">            Only used when Tracking.dimension is &#39;2D&#39;. (default None)</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;XST(with reference)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XST_self</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>

        <span class="k">return</span></div>


<div class="viewcode-block" id="Tracking.XST_withrefer_multi"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XST_withrefer_multi">[docs]</a>    <span class="k">def</span> <span class="nf">XST_withrefer_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for conventional XST technique, with reference beam.</span>
<span class="sd">        Two image stacks are needed. </span>
<span class="sd">        The fisrt image stack consists one image when the diffuser is in the beam,</span>
<span class="sd">        another image stack consists one reference image without the tested optic.</span>

<span class="sd">        .. warning:: **BE CAREFUL** to check the available and safe cpu numbers before run this function!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_x : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;x&#39; (scan in x direction), it is useless.</span>
<span class="sd">        edge_y : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in y dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            If Tracking.scandim=&#39;y&#39; (scan in y direction), it is useless.</span>
<span class="sd">        pad_x : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in x direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;y&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        pad_y : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do </span>
<span class="sd">            the tracking in y direction. If Tracking.dimension  is &#39;1D&#39; </span>
<span class="sd">            **and** Tracking.scandim is is &#39;x&#39;, it is useless.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The height (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the width (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">        window : int</span>
<span class="sd">            The width (when Tracking.scandim is &#39;y&#39;) </span>
<span class="sd">            or the height (when Tracking.scandim is &#39;x&#39;) </span>
<span class="sd">            of the subregion to be chosen from the template for cross-correlation.</span>
<span class="sd">            Only used when Tracking.dimension is &#39;2D&#39;. </span>
<span class="sd">        cpu_no : int</span>
<span class="sd">            The number of CPUs that is available.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;XST(with reference)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">XST_self_multi</span><span class="p">(</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span><span class="p">,</span> <span class="n">pad_x</span><span class="p">,</span> <span class="n">pad_y</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Tracking.XSVT_withrefer"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XSVT_withrefer">[docs]</a>    <span class="k">def</span> <span class="nf">XSVT_withrefer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">hw_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad_xy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for XSVT technique with reference beam.</span>
<span class="sd">        The fisrt image stack is the one with test optic.</span>
<span class="sd">        The second image stack is the reference image stack.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_xy : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x and y dimensions.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        edge_z : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in scan number dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The width and height of the image subregion. </span>
<span class="sd">            Needed when do 2D data processing. (default None) </span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            Needed when do 2D data processing. (default None)</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;XSVT(with reference)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span> <span class="o">=</span> <span class="mf">1.</span>    <span class="c1"># Dummy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The 1D data processing is not supported for XSVT method. </span><span class="se">\</span>
<span class="s2">                    Instead, you can cut a small strip of data and do 2D </span><span class="se">\</span>
<span class="s2">                    data processing and extract the information you want.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="p">)</span>

        <span class="c1">#Use the underscored delay in the XSS method, thus delayY is _delayX, delayX is _delayY.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;xy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XSS_withrefer</span><span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">delayX</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">)</span>
        <span class="n">delayY</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">delayX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span> 

        <span class="k">return</span></div>

<div class="viewcode-block" id="Tracking.XSVT_withrefer_multi"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.XSVT_withrefer_multi">[docs]</a>    <span class="k">def</span> <span class="nf">XSVT_withrefer_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Speckle tracking for XSVT technique with reference beam.</span>
<span class="sd">        The fisrt image stack is the one with test optic.</span>
<span class="sd">        The second image stack is the reference image stack.</span>

<span class="sd">        .. warning:: **BE CAREFUL** to check the available and safe cpu numbers before run this function!!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_xy : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in x and y dimensions.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">        edge_z : int, or [int, int]</span>
<span class="sd">            Area needs to be cut in scan number dimension.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int).</span>
<span class="sd">        hw_xy : int</span>
<span class="sd">            The width and height of the image subregion. </span>
<span class="sd">            Needed when do 2D data processing.  </span>
<span class="sd">        pad_xy : int, or [int, int]</span>
<span class="sd">            It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">            If it is a single integer, it will be expanded automatically </span>
<span class="sd">            to (int, int). </span>
<span class="sd">            Needed when do 2D data processing. </span>
<span class="sd">        cpu_no : int</span>
<span class="sd">            The number of CPUs that is available.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;XSVT(with reference)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanstep</span> <span class="o">=</span> <span class="mf">1.</span>    <span class="c1"># Dummy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The 1D data processing is not supported for XSVT method. </span><span class="se">\</span>
<span class="s2">                    Instead, you can cut a small strip of data and do 2D </span><span class="se">\</span>
<span class="s2">                    data processing and extract the information you want.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">edge_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge_z</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack3</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imstack4</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="p">)</span>

        <span class="c1">#Use the underscored delay in the XSS method, thus delayY is _delayX, delayX is _delayY.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;xy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XSS_withrefer_multi</span><span class="p">(</span><span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_xy</span><span class="p">,</span> <span class="n">edge_z</span><span class="p">,</span> <span class="n">hw_xy</span><span class="p">,</span> <span class="n">pad_xy</span><span class="p">,</span> <span class="n">cpu_no</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">delayX</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span><span class="p">)</span>
        <span class="n">delayY</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">delayX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayX</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_delayY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sloX</span> <span class="o">=</span> <span class="kc">None</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_sloY</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloX</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sloY</span> <span class="o">=</span> <span class="n">slope_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delayY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scandim</span> <span class="o">=</span> <span class="s1">&#39;random&#39;</span> 

        <span class="k">return</span></div>


<div class="viewcode-block" id="Tracking.Hartmann_XST"><a class="viewcode-back" href="../../spexwavepy.html#spexwavepy.trackfun.Tracking.Hartmann_XST">[docs]</a>    <span class="k">def</span> <span class="nf">Hartmann_XST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cen_xmesh</span><span class="p">,</span> <span class="n">cen_ymesh</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hartmann-like data processing procedure.</span>
<span class="sd">        Two image stacks are needed.</span>
<span class="sd">        The fisrt image stack consists one sample image.</span>
<span class="sd">        The second image stack consists another reference image.</span>

<span class="sd">        .. note::</span>
<span class="sd">            For simplicity, unlike other mode of data processing, </span>
<span class="sd">            we only provide ``Tracking.delayX`` and ``Tracking.delayY``</span>
<span class="sd">            for this method. Recovering the appropriate physical quantities </span>
<span class="sd">            from the speckle shifts is left to the discretion of the users.</span>
<span class="sd">            </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cen_xmsh : numpy.ndarray </span>
<span class="sd">           Mesh grid of the x coordinate of the box centre. A 2D array.</span>
<span class="sd">        cen_ymsh : numpy.ndarray </span>
<span class="sd">           Mesh grid of the y coordinate of the box centre. A 2D array.</span>
<span class="sd">        pad : int, or [int, int]</span>
<span class="sd">           It defines the extra part the reference image needed to do the tracking.</span>
<span class="sd">           If it is a single integer, it will be expanded automatically </span>
<span class="sd">           to (int, int). </span>
<span class="sd">        size : int, or [int, int]</span>
<span class="sd">           It defines the size of the box used for Hartmann-like tracking mode.</span>
<span class="sd">           If it is a single integer, it will be expanded automatically </span>
<span class="sd">           to (int, int). size[0] is the half width of the chosen box, size[1] is </span>
<span class="sd">           the half height of the chosen box.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            To normalize the stitched image or not. (default False)</span>
<span class="sd">        display : bool</span>
<span class="sd">            To display or not. (default False)</span>
<span class="sd">        verbose : bool</span>
<span class="sd">            To show the information or not. (default True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="s2">&quot;Hartmann-like&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide another image stack.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">rawdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span> <span class="o">=</span> <span class="n">cen_xmesh</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">delayX_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="p">))</span>
        <span class="n">delayY_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="p">))</span>
        <span class="n">res_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">x_dim_tmp</span><span class="p">))</span>
        <span class="n">imstack1_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack1</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">imstack2_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imstack2</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">im_sam_init</span> <span class="o">=</span> <span class="n">imstack1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cen_ymesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">cen_ymesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cen_xmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">cen_xmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
        <span class="n">im_ref_init</span> <span class="o">=</span> <span class="n">imstack2_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cen_ymesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">cen_ymesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cen_xmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">cen_xmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
        <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">im_sam_init</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">im_sam_init</span><span class="p">)</span> 
            <span class="n">im_ref_init</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">im_ref_init</span><span class="p">)</span> 
        <span class="n">ix_init</span><span class="p">,</span> <span class="n">iy_init</span><span class="p">,</span> <span class="n">res_init</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">im_ref_init</span><span class="p">,</span> <span class="n">im_sam_init</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span> <span class="o">=</span> <span class="n">_initDisplay</span><span class="p">(</span><span class="n">im_sam_init</span><span class="p">,</span> <span class="n">im_ref_init</span><span class="p">,</span> <span class="n">res_init</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_dim_tmp</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">_indicator</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">y_dim_tmp</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_dim_tmp</span><span class="p">):</span>
                <span class="n">cen_index_x</span> <span class="o">=</span> <span class="n">cen_xmesh</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span>
                <span class="n">cen_index_y</span> <span class="o">=</span> <span class="n">cen_ymesh</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span>
                <span class="n">im_sam</span> <span class="o">=</span> <span class="n">imstack1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cen_index_y</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">cen_index_y</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cen_index_x</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">cen_index_x</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
                <span class="n">im_ref</span> <span class="o">=</span> <span class="n">imstack2_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cen_index_y</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">cen_index_y</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cen_index_x</span><span class="o">-</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">cen_index_x</span><span class="o">+</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> 
                <span class="n">subpixelmeth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpixelmeth</span> 
                <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                    <span class="n">im_sam</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">im_sam</span><span class="p">)</span> 
                    <span class="n">im_ref</span> <span class="o">=</span> <span class="n">NormImage</span><span class="p">(</span><span class="n">im_ref</span><span class="p">)</span> 
                <span class="n">ix_tmp</span><span class="p">,</span> <span class="n">iy_tmp</span><span class="p">,</span> <span class="n">res_tmp</span> <span class="o">=</span> <span class="n">Imagematch</span><span class="p">(</span><span class="n">im_ref</span><span class="p">,</span> <span class="n">im_sam</span><span class="p">,</span> <span class="n">subpixelmeth</span><span class="o">=</span><span class="n">subpixelmeth</span><span class="p">)</span>
                <span class="n">delayX_2D</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix_tmp</span> <span class="o">-</span> <span class="n">pad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">delayY_2D</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">iy_tmp</span> <span class="o">-</span> <span class="n">pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">res_2D</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_tmp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                    <span class="n">_contiDisplay</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">h3</span><span class="p">,</span> <span class="n">h4</span><span class="p">,</span> <span class="n">im_sam</span><span class="p">,</span> <span class="n">im_ref</span><span class="p">,</span> <span class="n">res_tmp</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">delayY</span> <span class="o">=</span> <span class="n">delayY_2D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delayX</span> <span class="o">=</span> <span class="n">delayX_2D</span>
    
        <span class="k">return</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">spexwavepy 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">spexwavepy.trackfun</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2024, Lingfei Hu, Hongchang Wang.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>